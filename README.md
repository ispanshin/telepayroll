# TelePayroll — Telegram‑бот для учёта посещаемости и расчёта выплат

Мини‑бот на **aiogram v3**. Делает мультивыборный опрос в привязанном групповом чате, принимает ответы (`poll_answer`), показывает сводку «payroll» и позволяет добавлять новых голосовавших в ростер.

## Требования

- Python **3.10+**
- Аккаунт бота в Telegram и токен ([@BotFather](https://t.me/BotFather))
- Unix/macOS/Windows — без разницы (ниже есть команды для обеих систем)

## Установка и запуск (через venv + зависимости из `pyproject.toml`)

```bash
git clone <your-repo-url> telepayroll
cd telepayroll

# 1) создаём и активируем виртуальное окружение
python3 -m venv .venv
# macOS/Linux:
source .venv/bin/activate
# Windows (PowerShell):
# .\.venv\Scripts\Activate.ps1

# 2) обновим pip и поставим зависимости проекта (читаются из pyproject.toml)
pip install --upgrade pip
pip install .

# 3) создаём .env в корне репозитория
# пример:
# BOT_TOKEN=123456:ABCDEF
# ADMIN_IDS=11111111,22222222
# DATA_DIR=./data

# 4) запуск
python -m telepayroll.app.main
```

### Переменные окружения (`.env`)

```dotenv
BOT_TOKEN=123456:ABCDEF                # токен бота
ADMIN_IDS=11111111,22222222            # список id админов через запятую
DATA_DIR=./data                        # где хранить SQLite-файл (по умолчанию ./data/telepayroll.sqlite3)
# DB_PATH=/absolute/path/to/telepayroll.sqlite3  # опционально переопределяет путь до БД
```

> SQLite-файл создаётся автоматически при первом запуске, режим WAL включён.

## Как пользоваться

1. **Добавь бота** в нужный групповой чат (куда будут публиковаться опросы). Дай ему право отправлять опросы.
2. Зайди в этот чат **админом** (из `ADMIN_IDS`) и дай команду:  
   **`/bind_here`** — бот запомнит `chat_id` как «чат информатики» для опросов.
3. В личке с ботом (или там, где удобно) админ запускает мастер:  
   **`/newpoll`** → вводит вопрос → вводит варианты (через запятую или с новой строки).  
   Бот публикует **неанонимный** мультивыборный опрос в привязанном чате.
4. Участники голосуют. Бот получает `poll_answer` и сохраняет ответы.
5. Админ смотрит сводку:  
   **`/payroll`** — видит таблицу «кто проголосовал/сколько занятий × ставка = сумма», общий итог, а также «новых голосовавших» (не из ростера).  
   Внизу — кнопки **«Добавить …»**, чтобы включить нового человека в ростер (ставка по умолчанию 1.0).

## Команды

- **/start** — краткая справка.
- **/bind_here** — выполнить **в целевом групповом чате** админом; привязка чата для опросов.
- **/newpoll** — мастер создания опроса (FSM: вопрос → варианты).
- **/payroll** — показать итоги по **последнему** опросу с кнопками добавления в ростер.

## Архитектура (слои)

```
telepayroll/app
├─ infra/            # база и репозитории (SQLite, SQL изолирован здесь)
│  ├─ db.py          # connect() + ensure_schema() (WAL, короткие транзакции)
│  └─ repos/         # PollsRepo, VotesRepo, TeachersRepo, SettingsRepo
├─ domain/           # "чистая" бизнес‑логика (без aiogram/БД)
│  └─ payroll.py     # PayrollContext, расчёты, агрегации
├─ services/         # use‑cases (склеивают домен + репозитории + Bot)
│  ├─ polls.py       # отправка опроса, сохранение poll_id
│  └─ ui.py          # форматирование текста/клавиатуры для экранов
├─ handlers/         # aiogram‑хендлеры и FSM
│  ├─ common.py      # /start, /newpoll (FSM)
│  ├─ informatics.py # /bind_here, on_poll_answer
│  └─ payroll.py     # /payroll и кнопки «Добавить»
├─ middlewares/
│  └─ context_injector.py  # прокидывает AppContext во все апдейты
├─ context.py        # сборка AppContext (бот, настройки, репозитории, сервисы)
└─ config.py         # pydantic‑settings (.env), путь к базе, id админов
```

**Принципы:**  
- Хендлеры «тонкие»: только парсят вход, вызывают use‑cases и возвращают UI.  
- SQL только в репозиториях (`infra/repos/*`).  
- Доменные функции чистые (легко тестировать).  
- UI формируется отдельно и не ходит в БД.

## Данные и хранение

- База: **SQLite** (`DATA_DIR/telepayroll.sqlite3` или `DB_PATH`).
- Включён **WAL** и `synchronous=NORMAL` для стабильности.
- Ростер хранится в таблице `teachers` (id, name, default_rate).
- Ответы — в `votes` (poll_id, user_id, выбранные опции и т.д.).
- Сервис `PayrollService` поднимает контекст из репозиториев и отдаёт в UI.

## Ограничения (MVP)

- **Один инстанс** бота (один сервер/процесс). Шардирование не предусмотрено.
- **Память FSM** — `MemoryStorage`. Шаги мастера `/newpoll` теряются при рестарте процесса.
- **Один привязанный чат** для опросов (`/bind_here` сохраняет `informatics_chat_id`). Несколько чатов пока не поддерживаются.
- **Ставка по умолчанию 1.0** при добавлении нового человека через кнопку «Добавить …». Изменение ставки через UI пока не реализовано.
- **Нет логирования** по умолчанию. Диагностика — через сообщения об ошибках.
- Опросы создаются **неанонимные**, **мультивыбор**. Другие типы (квизы/анонимные) пока не используются.
- Доступ к административным командам ограничен списком `ADMIN_IDS` из `.env`.

## Расширения, которые можно добавить дальше

- Перейти на `aiosqlite` (не блокировать event‑loop), не меняя архитектуру.
- Сделать редактирование ставки/имени из UI (отдельные callback‑кнопки и FSM).
- Добавить экспорт в CSV/Excel.
- Вынести тексты в набор локализаций.
- Добавить логирование и трейсинг (middleware ошибок).

## Тестирование (минимум)

- Домен (`domain/payroll.py`) тестируется как чистые функции (без aiogram/БД).  
- Репозитории — интеграционными тестами на временной SQLite‑файл.

## Частые проблемы

- **/bind_here не срабатывает** — проверь, что команду даёт именно админ (из `ADMIN_IDS`) и что команда введена *в групповом чате*.
- **Опрос не отправляется** — бот не в чате, нет прав отправлять опросы, или чат не привязан (`/bind_here`).
- **Не приходят ответы** — проверь, что опрос **неанонимный** (бот создаёт его таким). Бот должен быть тем, кто опубликовал опрос.
- **/payroll пишет, что опросов нет** — запусти `/newpoll` и дождись публикации опроса в привязанном чате.
