# TelePayroll — Telegram‑бот для учёта посещаемости и расчёта выплат

Мини‑бот на **aiogram v3**. Делает мультивыборный опрос в привязанном групповом чате, принимает ответы (`poll_answer`), показывает сводку «payroll» и позволяет добавлять новых голосовавших в ростер.

## Требования

- Python **3.10+**
- Аккаунт бота в Telegram и токен ([@BotFather](https://t.me/BotFather))
- Unix/macOS/Windows — без разницы (ниже есть команды для обеих систем)

## Установка и запуск (через venv + зависимости из `pyproject.toml`)

```bash
git clone <your-repo-url> telepayroll
cd telepayroll

# 1) создаём и активируем виртуальное окружение
python3 -m venv .venv
# macOS/Linux:
source .venv/bin/activate
# Windows (PowerShell):
# .\.venv\Scripts\Activate.ps1

# 2) обновим pip и поставим зависимости проекта (читаются из pyproject.toml)
pip install --upgrade pip
pip install .

# 3) создаём .env в корне репозитория
# пример:
# BOT_TOKEN=123456:ABCDEF
# ADMIN_IDS=11111111,22222222
# DATA_DIR=./data

# 4) запуск
python -m telepayroll.app.main
```

### Переменные окружения (`.env`)

```dotenv
BOT_TOKEN=123456:ABCDEF                # токен бота
ADMIN_IDS=11111111,22222222            # список id админов через запятую
DATA_DIR=./data                        # где хранить SQLite-файл (по умолчанию ./data/telepayroll.sqlite3)
# DB_PATH=/absolute/path/to/telepayroll.sqlite3  # опционально переопределяет путь до БД
```

> SQLite-файл создаётся автоматически при первом запуске, режим WAL включён.

## Как пользоваться

1. **Добавь бота** в нужный групповой чат (куда будут публиковаться опросы). Дай ему право отправлять опросы.
2. Зайди в этот чат **админом** (из `ADMIN_IDS`) и дай команду:  
   **`/bind_here`** — бот запомнит `chat_id` как «чат информатики» для опросов.
3. В личке с ботом (или там, где удобно) админ запускает мастер:  
   **`/newpoll`** → вводит вопрос → вводит варианты (через запятую или с новой строки).  
   Бот публикует **неанонимный** мультивыборный опрос в привязанном чате.
4. Участники голосуют. Бот получает `poll_answer` и сохраняет ответы.
5. Админ смотрит сводку:  
   **`/payroll`** — видит таблицу «кто проголосовал/сколько занятий × ставка = сумма», общий итог, а также «новых голосовавших» (не из ростера).  
   Внизу — кнопки **«Добавить …»**, чтобы включить нового человека в ростер (ставка по умолчанию 1.0).

## Тестирование (минимум)

- Домен (`domain/payroll.py`) тестируется как чистые функции (без aiogram/БД).  
- Репозитории — интеграционными тестами на временной SQLite‑файл.


